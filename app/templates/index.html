<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Архиватор страниц</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='index.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
<div class="container">
    <h1>Архиватор страниц</h1>

    <form id="addForm">
        <label for="urlInput">Введите URL:</label>
        <input type="text" id="urlInput" name="urlInput" required>

        <button type="button" onclick="addPage()">Добавить</button>

        <!-- Чекбокс ниже кнопки -->
        <div class="checkbox-container" style="margin-top: 10px;">
            <input type="checkbox" id="protectedPageCheckbox" name="protectedPage">
            <label for="protectedPageCheckbox">Это защищённая страница?</label>
        </div>
    </form>

    <button type="button" onclick="showPage()">Показать сохранённую страницу</button>

    <button type="button" id="domainInfoButton" onclick="toggleDomainInfo()">Показать информацию о домене</button>
    <button type="button" id="logoutButton" onclick="logout()">Выйти</button>

    <div id="displayArea"></div>

</div>

<script src="{{ url_for('static', filename='index.js') }}"></script>
<script>
async function addPage() {
    const urlInput = document.getElementById("urlInput").value.trim();
    const isProtected = document.getElementById("protectedPageCheckbox").checked;

    if (!urlInput) {
        Swal.fire('Ошибка!', 'Введите URL.', 'error');
        return;
    }

    let needAuthWindow = false;
    let unsupportedSite = false;

    // Проверка на неподдерживаемые сайты до того, как показывать прелоадер
    if (!urlInput.includes("cs") && !urlInput.includes("edu") && !urlInput.includes("vk")) {
        if (isProtected) {
            unsupportedSite = true;
        }
    }

    if (unsupportedSite) {
        Swal.fire('Ошибка!', 'Пока поддерживаются только ВК, БРС и Moodle.', 'error');
        return;
    }

    try {
        if (urlInput.includes("cs") || urlInput.includes("edu")) {
            // Только если это не ВК, показываем прелоадер
            Swal.fire({
                title: 'Проверка авторизации...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            if (urlInput.includes("cs")) {
                const response = await fetch('/auth/check?type=brs');
                const authData = await response.json();
                if (authData.need_auth) {
                    needAuthWindow = true;
                }
            } else if (urlInput.includes("edu")) {
                const response = await fetch('/auth/check?type=moodle');
                const authData = await response.json();
                if (authData.need_auth) {
                    needAuthWindow = true;
                }
            }

            Swal.close();  // Закрываем прелоадер после проверки
        } else if (urlInput.includes("vk")) {
            needAuthWindow = true;  // Для VK сразу нужна авторизация, без прелоадера
        }
    } catch (error) {
        console.error("Ошибка при проверке авторизации:", error);
        Swal.close(); // Закрыть прелоадер перед показом ошибки
        Swal.fire('Ошибка!', 'Ошибка при проверке авторизации.', 'error');
        return;
    }

    if (needAuthWindow) {
        Swal.fire({
            title: 'Введите данные для авторизации',
            html:
                '<input id="swal-login" class="swal2-input" placeholder="Логин">' +
                '<input id="swal-password" type="password" class="swal2-input" placeholder="Пароль">' +
                '<input id="swal-code" class="swal2-input" placeholder="Код (если ВК)">',
            confirmButtonText: 'Отправить',
            focusConfirm: false,
            preConfirm: () => {
                return {
                    login: document.getElementById('swal-login').value,
                    password: document.getElementById('swal-password').value,
                    code: document.getElementById('swal-code').value
                }
            }
        }).then((result) => {
            if (result.isConfirmed) {
                const credentials = result.value;
                sendAddPageRequest(urlInput, isProtected, credentials);
            }
        });
    } else {
        sendAddPageRequest(urlInput, isProtected);
    }
}

function sendAddPageRequest(urlInput, isProtected, credentials = null) {
    const data = {
        url: urlInput,
        protected: isProtected,
        credentials: credentials
    };

    // Показать прелоадер перед отправкой
    Swal.fire({
        title: 'Сохраняем страницу...',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    fetch("/archive", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        Swal.close(); // Закрыть прелоадер

        if (data.success) {
            Swal.fire('Успех!', 'Страница добавлена!', 'success');
        } else {
            Swal.fire('Ошибка!', data.error || 'Ошибка при добавлении страницы.', 'error');
        }
    })
    .catch(error => {
        Swal.close(); // Закрыть прелоадер даже в случае ошибки

        console.error("Ошибка:", error);
        Swal.fire('Ошибка!', 'Что-то пошло не так!', 'error');
    });
}


function toggleDomainInfo() {
    const domainInfoButton = document.getElementById("domainInfoButton");
    const displayArea = document.getElementById("displayArea");
    const urlInput = document.getElementById("urlInput").value.trim();

    if (!urlInput) {
        Swal.fire('Ошибка!', 'Введите URL для получения информации о домене.', 'error');
        return;
    }

    // Если информация уже отображается, скрываем её
    if (displayArea.style.display === 'block') {
        displayArea.style.display = 'none';
        domainInfoButton.innerText = 'Показать информацию о домене';
        return;
    }

    // Показать прелоадер
    Swal.fire({
        title: 'Загружаем информацию о домене...',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    fetch(`/view_domain_info/${encodeURIComponent(urlInput)}`)
        .then(response => response.text()) // Получаем HTML в виде строки
        .then(data => {
            // Закрыть прелоадер
            Swal.close();

            // Вставить полученный HTML в displayArea
            displayArea.innerHTML = data;

            // Развернуть блок и изменить текст кнопки
            displayArea.style.display = 'block';  // Показываем блок
            domainInfoButton.innerText = 'Скрыть информацию о домене';  // Меняем текст на кнопке
        })
        .catch(error => {
            Swal.close(); // Закрыть прелоадер в случае ошибки
            console.error("Ошибка при загрузке информации о домене:", error);
            Swal.fire('Ошибка!', 'Не удалось загрузить информацию о домене.', 'error');
        });
}

</script>

<script>
    function logout() {
        // Отправляем запрос на сервер для выхода
        fetch('/logout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Показываем уведомление с помощью SweetAlert2
                Swal.fire({
                    title: 'Выход',
                    text: data.message,  // Текст сообщения, который возвращает сервер
                    icon: 'success',
                    confirmButtonText: 'OK'
                }).then(() => {
                    // После того как пользователь закроет уведомление, редиректим на страницу входа
                    window.location.href = '/login';  // Перенаправляем на страницу входа
                });
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            Swal.fire({
                title: 'Ошибка!',
                text: 'Произошла ошибка при выходе.',
                icon: 'error',
                confirmButtonText: 'OK'
            });
        });
    }
</script>

</body>
</html>
